# Testing Patterns & Examples

**Last Updated:** 2025-12-05
**Reference:** Reusable patterns from successful Phase 1 tests

---

## ðŸŽ¯ Hook Testing Patterns

### 1. Basic Hook Test Template

```typescript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest'
import { renderHook, act } from '@testing-library/react'
import { useMyHook } from './useMyHook'

describe('useMyHook', () => {
  beforeEach(() => {
    // Setup: reset mocks, create fixtures
    vi.clearAllMocks()
  })

  afterEach(() => {
    // Cleanup: restore state
    vi.resetAllMocks()
  })

  describe('happy path', () => {
    it('should initialize with default values', () => {
      const { result } = renderHook(() => useMyHook())
      expect(result.current.value).toBe('default')
    })

    it('should update state when action is called', async () => {
      const { result } = renderHook(() => useMyHook())
      await act(async () => {
        result.current.updateValue('new')
      })
      expect(result.current.value).toBe('new')
    })
  })

  describe('error handling', () => {
    it('should handle errors gracefully', async () => {
      const { result } = renderHook(() => useMyHook())
      await act(async () => {
        result.current.triggerError()
      })
      expect(result.current.error).toBeDefined()
    })
  })

  describe('edge cases', () => {
    it('should handle null/undefined inputs', () => {
      const { result } = renderHook(() => useMyHook(null))
      expect(result.current).toBeDefined()
    })
  })
})
```

### 2. Async Hook Testing Pattern

```typescript
describe('useAsyncHook', () => {
  it('should handle async operations', async () => {
    const { result } = renderHook(() => useAsyncHook())

    // Initial state
    expect(result.current.loading).toBe(true)

    // Wait for async operation
    await waitFor(() => {
      expect(result.current.loading).toBe(false)
    })

    // Check result
    expect(result.current.data).toEqual(expectedData)
  })

  it('should handle async errors', async () => {
    vi.mocked(fetchData).mockRejectedValueOnce(new Error('Network error'))

    const { result } = renderHook(() => useAsyncHook())

    await waitFor(() => {
      expect(result.current.error).toBe('Network error')
    })
  })
})
```

### 3. Hook with Context Provider

```typescript
import { ReactNode } from 'react'
import { QueryClientProvider, QueryClient } from '@tanstack/react-query'

const createTestQueryClient = () =>
  new QueryClient({
    defaultOptions: {
      queries: { retry: false },
      mutations: { retry: false }
    }
  })

const Wrapper = ({ children }: { children: ReactNode }) => (
  <QueryClientProvider client={createTestQueryClient()}>
    {children}
  </QueryClientProvider>
)

describe('useQueryHook', () => {
  it('should fetch data using React Query', async () => {
    const { result } = renderHook(() => useQueryHook(), { wrapper: Wrapper })

    await waitFor(() => {
      expect(result.current.isSuccess).toBe(true)
    })
  })
})
```

### 4. Hook with Mocked API

```typescript
describe('useColorExtraction', () => {
  beforeEach(() => {
    vi.mocked(apiClient.extractColors).mockResolvedValueOnce({
      colors: [{ hex: '#FF0000', confidence: 0.95 }]
    })
  })

  it('should extract colors from API', async () => {
    const { result } = renderHook(() => useColorExtraction())

    await act(async () => {
      await result.current.extract('image.jpg')
    })

    expect(result.current.colors).toHaveLength(1)
    expect(result.current.colors[0].hex).toBe('#FF0000')
  })
})
```

---

## ðŸ§ª Schema Validation Patterns

### 1. Basic Schema Validation

```typescript
import { describe, it, expect } from 'vitest'
import { ColorTokenSchema } from '@/types/color.zod'

describe('ColorTokenSchema', () => {
  describe('happy path', () => {
    it('should validate correct color token', () => {
      const valid = { hex: '#FF0000', confidence: 0.95, name: 'red' }
      const result = ColorTokenSchema.safeParse(valid)
      expect(result.success).toBe(true)
      if (result.success) {
        expect(result.data.hex).toBe('#FF0000')
      }
    })
  })

  describe('sad path', () => {
    it('should reject invalid hex format', () => {
      const invalid = { hex: 'not-hex', confidence: 0.95 }
      const result = ColorTokenSchema.safeParse(invalid)
      expect(result.success).toBe(false)
      if (!result.success) {
        expect(result.error.issues[0].code).toBe('invalid_string')
      }
    })
  })

  describe('edge cases', () => {
    it('should handle boundary values', () => {
      const boundary = { hex: '#000000', confidence: 0 }
      expect(ColorTokenSchema.safeParse(boundary).success).toBe(true)
    })

    it('should reject confidence > 1', () => {
      const invalid = { hex: '#FF0000', confidence: 1.5 }
      expect(ColorTokenSchema.safeParse(invalid).success).toBe(false)
    })
  })

  describe('required fields', () => {
    it('should reject missing required fields', () => {
      const incomplete = { hex: '#FF0000' } // missing confidence
      const result = ColorTokenSchema.safeParse(incomplete)
      expect(result.success).toBe(false)
    })
  })
})
```

### 2. Schema with Nested Objects

```typescript
describe('ComponentTokenSchema with nested values', () => {
  it('should validate nested structure', () => {
    const valid = {
      name: 'primary',
      tokens: {
        light: { value: '#FFFFFF', type: 'color' },
        dark: { value: '#000000', type: 'color' }
      }
    }
    const result = ComponentTokenSchema.safeParse(valid)
    expect(result.success).toBe(true)
  })

  it('should validate with custom properties', () => {
    const valid = {
      name: 'primary',
      tokens: { ... },
      metadata: {
        category: 'semantic',
        usage: 'primary actions'
      }
    }
    const result = ComponentTokenSchema.safeParse(valid)
    expect(result.success).toBe(true)
  })
})
```

---

## ðŸ§© Component Testing Patterns

### 1. Component with Props

```typescript
import { render, screen } from '@testing-library/react'
import { ColorDisplay } from './ColorDisplay'

describe('ColorDisplay component', () => {
  it('should render color token', () => {
    const color = { hex: '#FF0000', name: 'red', confidence: 0.95 }
    render(<ColorDisplay color={color} />)

    expect(screen.getByText('red')).toBeInTheDocument()
    expect(screen.getByText('#FF0000')).toBeInTheDocument()
  })

  it('should display confidence percentage', () => {
    const color = { hex: '#FF0000', name: 'red', confidence: 0.95 }
    render(<ColorDisplay color={color} />)

    expect(screen.getByText('95%')).toBeInTheDocument()
  })
})
```

### 2. Component with User Interaction

```typescript
import { render, screen, fireEvent } from '@testing-library/react'
import { ColorPicker } from './ColorPicker'

describe('ColorPicker component', () => {
  it('should update selected color on click', async () => {
    const colors = [
      { hex: '#FF0000', name: 'red' },
      { hex: '#00FF00', name: 'green' }
    ]
    const onSelect = vi.fn()

    render(<ColorPicker colors={colors} onSelect={onSelect} />)

    fireEvent.click(screen.getByText('red'))

    expect(onSelect).toHaveBeenCalledWith(colors[0])
  })
})
```

### 3. Component with Mocked Hook

```typescript
import { render, screen } from '@testing-library/react'
import { useColorExtraction } from '@/hooks/useColorExtraction'
import { ColorExtractionWidget } from './ColorExtractionWidget'

vi.mock('@/hooks/useColorExtraction')

describe('ColorExtractionWidget', () => {
  it('should display extracted colors', () => {
    vi.mocked(useColorExtraction).mockReturnValue({
      colors: [{ hex: '#FF0000', name: 'red' }],
      loading: false,
      error: null
    })

    render(<ColorExtractionWidget />)

    expect(screen.getByText('red')).toBeInTheDocument()
  })

  it('should show loading state', () => {
    vi.mocked(useColorExtraction).mockReturnValue({
      colors: [],
      loading: true,
      error: null
    })

    render(<ColorExtractionWidget />)

    expect(screen.getByText('Loading...')).toBeInTheDocument()
  })
})
```

---

## ðŸŽ¬ E2E Testing Patterns

### 1. Basic E2E Test

```typescript
import { test, expect } from '@playwright/test'

test('user can upload image and extract colors', async ({ page }) => {
  // Navigate to page
  await page.goto('/')

  // Upload image
  await page.click('input[type="file"]')
  await page.setInputFiles('input[type="file"]', 'test-image.jpg')

  // Wait for extraction
  await page.waitForSelector('.color-token')

  // Verify results
  const colors = await page.locator('.color-token').count()
  expect(colors).toBeGreaterThan(0)
})
```

### 2. E2E with Error Handling

```typescript
test('user sees error for invalid file', async ({ page }) => {
  await page.goto('/')

  // Upload invalid file
  await page.click('input[type="file"]')
  await page.setInputFiles('input[type="file"]', 'invalid.txt')

  // Check error message
  const error = page.locator('[role="alert"]')
  await expect(error).toContainText('Invalid format')
})
```

### 3. E2E with Network Mocking

```typescript
test('user sees error when API fails', async ({ page }) => {
  // Intercept API calls
  await page.route('**/api/extract', route => route.abort())

  await page.goto('/')

  // Attempt extraction
  await page.click('input[type="file"]')
  await page.setInputFiles('input[type="file"]', 'test-image.jpg')

  // Verify error handling
  await expect(page.locator('[role="alert"]')).toContainText('Error')
})
```

---

## ðŸ“Š Mock Data Factories

### 1. Color Token Factory

```typescript
// test/factories/colorToken.ts
export const createColorToken = (overrides = {}) => ({
  hex: '#FF0000',
  name: 'red',
  confidence: 0.95,
  category: 'primary',
  ...overrides
})

// Usage in tests
const token = createColorToken({ hex: '#00FF00', name: 'green' })
```

### 2. Mock API Response Factory

```typescript
// test/factories/apiResponses.ts
export const mockColorExtractionResponse = (count = 5) => ({
  colors: Array.from({ length: count }, (_, i) => ({
    hex: `#${String(i).padStart(6, '0')}`,
    confidence: 0.9 + (i % 10) * 0.01,
    name: `color-${i}`
  })),
  duration: 1234,
  model: 'claude-sonnet'
})

// Usage in tests
const response = mockColorExtractionResponse(10)
```

### 3. Mock Store State Factory

```typescript
// test/factories/storeState.ts
export const createMockStoreState = (overrides = {}) => ({
  projects: [],
  colors: [],
  selectedProject: null,
  isLoading: false,
  error: null,
  ...overrides
})

// Usage in tests
const state = createMockStoreState({
  colors: [createColorToken()]
})
```

---

## ðŸ”§ Testing Utilities Reference

See [TEST_UTILITIES.md](./TEST_UTILITIES.md) for detailed utility documentation.

### Quick Reference

```typescript
// From hookTestUtils.ts
import {
  createTestQueryClient,      // QueryClient for React Query
  renderHookWithProviders,    // renderHook with all providers
  createMockColorResponse,    // Mock API responses
  createMockStoreState,       // Mock Redux/store state
  waitForAsync                // Helper for async tests
} from '@/test/hookTestUtils'

// Usage
const { result } = renderHook(() => useMyHook(), {
  wrapper: ({ children }) => (
    <QueryClientProvider client={createTestQueryClient()}>
      {children}
    </QueryClientProvider>
  )
})
```

---

## âœ… Test Checklist Template

Use this checklist when writing new tests:

```typescript
describe('MyComponent/Hook', () => {
  // Setup & Teardown
  // âœ… beforeEach: Initialize mocks and fixtures
  // âœ… afterEach: Clean up and reset mocks

  // Happy Path Tests
  // âœ… Default behavior works
  // âœ… With valid inputs, produces expected output
  // âœ… State updates correctly
  // âœ… Callbacks are invoked correctly

  // Error Cases
  // âœ… Handles null/undefined inputs
  // âœ… Handles API errors gracefully
  // âœ… Shows error messages
  // âœ… Recovers from errors

  // Edge Cases
  // âœ… Boundary values (min/max)
  // âœ… Empty collections
  // âœ… Duplicate values
  // âœ… Special characters
  // âœ… Very large numbers

  // Performance & Memory
  // âœ… No memory leaks
  // âœ… Memoization works
  // âœ… Cleanup on unmount

  // Integration
  // âœ… Works with other components/hooks
  // âœ… Props pass through correctly
  // âœ… Context values are accessible
})
```

---

## ðŸ“š Common Assertion Patterns

### String Assertions

```typescript
expect(result.current.message).toBe('exact match')
expect(result.current.message).toContain('substring')
expect(result.current.message).toMatch(/regex/)
expect(result.current.message).toHaveLength(10)
```

### Number & Boolean Assertions

```typescript
expect(result.current.count).toBeGreaterThan(0)
expect(result.current.count).toBeLessThanOrEqual(100)
expect(result.current.count).toBeBetween(0, 100)
expect(result.current.active).toBe(true)
expect(result.current.active).toBeTruthy()
```

### Array & Object Assertions

```typescript
expect(result.current.colors).toHaveLength(3)
expect(result.current.colors).toEqual([...])
expect(result.current.colors).toContainEqual({ hex: '#FF0000' })
expect(result.current).toHaveProperty('name')
expect(result.current).toMatchObject({ hex: '#FF0000' })
```

### Error Assertions

```typescript
expect(() => badFunction()).toThrow()
expect(() => badFunction()).toThrow('specific message')
expect(result.current.error).toBeNull()
expect(result.current.error).toBeDefined()
```

### Async Assertions

```typescript
await waitFor(() => {
  expect(result.current.loading).toBe(false)
})

expect(mockFunction).toHaveBeenCalled()
expect(mockFunction).toHaveBeenCalledWith(expectedArgs)
expect(mockFunction).toHaveBeenCalledTimes(1)
```

---

## ðŸŽ“ Learning Resources

### From Phase 1 Tests

**Best Examples:**
- `frontend/src/components/color-science/__tests__/hooks.test.ts` - Comprehensive hook testing
- `frontend/src/components/image-uploader/__tests__/hooks-tier1.test.ts` - Async patterns
- `frontend/src/components/overview-narrative/__tests__/hooks-tier1.test.ts` - Memoization testing

**Key Techniques Used:**
1. âœ… Mock factories for consistent test data
2. âœ… Provider wrappers for context testing
3. âœ… Mocked API responses for deterministic tests
4. âœ… Edge case coverage for robustness
5. âœ… Error scenario testing for reliability

---

**Document Version:** 1.0
**Last Updated:** 2025-12-05
**Reference:** Real patterns from 108 passing tests
